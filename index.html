<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>路面观察记录 Road Observation Recorder</title>

<!-- JSZip CDN -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; padding:10px; }
.hidden { display:none; }
button { padding:12px 20px; margin:5px 0; font-size:16px; width:100%; text-align:left; box-sizing:border-box;}
select, input[type=text], textarea { width:100%; padding:8px; margin:5px 0; font-size:16px; box-sizing:border-box; }
.container { max-width:640px; margin:auto; padding-bottom:80px;}
h2,h3 { text-align:center; margin:8px 0; }
textarea { height:100px; }
#violationCount { position:fixed; top:10px; left:10px; font-size:14px; z-index:1000; background:rgba(255,255,255,0.9); padding:6px 8px; border-radius:6px; }
#menuContainer { position:fixed; top:10px; right:10px; z-index:1000; width:160px; }
#menuContainer button { font-size:14px; margin:6px 0; width:100%; display:block; }
.behavior-btn { text-align:left; display:block; padding:12px; margin:6px 0; font-size:16px; border-radius:8px; border:1px solid #ddd; background:#fff; }
.behavior-btn:active { background:#eef; }
.small-note { font-size:12px; color:#666; margin-top:6px; text-align:center; }
</style>
</head>
<body>

<!-- 左上：违规次数 -->
<div id="violationCount" class="hidden">已记录的次数：0</div>

<!-- 右上折叠菜单 -->
<div id="menuContainer" class="hidden">
  <button id="menuToggleBtn">☰ 菜单</button>
  <div id="menu" class="hidden">
    <button onclick="pauseResume()" id="pauseBtn">暂停记录</button>
    <button onclick="exportZip()" id="exportBtn">停止并导出（ZIP）</button>
  </div>
</div>

<div class="container">

  <!-- 登录页 -->
  <div id="loginPage">
    <h2>登录</h2>
    <label>观察人代号:<br><input type="text" id="observer" placeholder="请输入观察人代号"></label>
    <button onclick="login()">登录</button>
    <p class="small-note">登录后左上显示已记录次数，右上显示菜单按钮。</p>
  </div>

  <!-- 首页 / 记录信息 -->
  <div id="page1" class="hidden">
    <h2>记录信息</h2>
    <label>观察地址 / 位置 ID：<br><input type="text" id="location" placeholder="例如 Site-01 或 路口A"></label>

    <label>地点类型：<br>
    <select id="locationType">
      <option>老居住区</option>
      <option>新居住区</option>
      <option>商业区</option>
      <option>交通枢纽</option>
      <option>生活辅助设施（学校、医院等）</option>
      <option>工业区</option>
      <option>绿地</option>
      <option>其他</option>
    </select></label>

    <label>天气（可多选）：<br>
    <select id="weather" multiple size="5">
      <option>晴</option>
      <option>多云</option>
      <option>阴</option>
      <option>阵雨</option>
      <option>雷暴</option>
      <option>小到中雨</option>
      <option>大雨以上</option>
      <option>雾霾</option>
      <option>冰雪</option>
      <option>其他</option>
    </select></label>

    <label>道路类型：<br>
    <select id="roadType">
      <option>十字路口</option>
      <option>T型路口</option>
      <option>直线道路</option>
      <option>单行线</option>
      <option>单车道公路</option>
      <option>多车道公路</option>
      <option>立交桥路口</option>
      <option>其他</option>
    </select></label>

    <button onclick="startRecording()">开始记录</button>
  </div>

  <!-- 拍照选项 -->
  <div id="pagePhoto" class="hidden">
    <h3>是否对该行为拍照？</h3>
    <button onclick="takePhotoThenMenu()">拍照 / 选图</button>
    <button onclick="skipPhotoThenMenu()">跳过拍照</button>
    <p class="small-note">注：拍照后会进入行为选择页面；取消也会进入下一步。</p>
  </div>

  <!-- 一级行为按钮 -->
  <div id="pagePrimary" class="hidden">
    <h3>请选择一级行为</h3>
    <div id="primaryButtons"></div>
  </div>

  <!-- 二级行为按钮 -->
  <div id="pageSecondary" class="hidden">
    <h3>请选择二级行为</h3>
    <div id="secondaryButtons"></div>
  </div>

  <!-- 三级行为按钮 -->
  <div id="pageTertiary" class="hidden">
    <h3>请选择三级行为</h3>
    <div id="tertiaryButtons"></div>
  </div>

  <!-- 多行为确认 -->
  <div id="pageMulti" class="hidden">
    <h3>是否还有其他违规行为要在同一违规ID下记录？</h3>
    <button onclick="multiChoice(true)">是（继续）</button>
    <button onclick="multiChoice(false)">否（结束该违规）</button>
  </div>

  <!-- 笔记页面 -->
  <div id="pageNote" class="hidden">
    <h3>填写备注（可选）</h3>
    <textarea id="note" placeholder="填写简短备注..."></textarea>
    <button onclick="saveRecord()">保存记录</button>
  </div>

</div>

<input id="cameraInput" type="file" accept="image/*" capture="environment" multiple style="display:none">

<script>
let records = [];
let currentRecord = null;
let paused = false;
let observerName = '';
let currentViolationID = 1;

const behaviors = {
  "闯红灯": {"左转":{"立即闯灯":null,"等候后闯灯":null},"直行":{"立即闯灯":null,"等候后闯灯":null},"右转":{"干扰其他方向":null}},
  "头盔违规":{"无头盔 No Helmet":null,"佩戴运动头盔":null,"不正确佩戴头盔":null},
  "逆行":{"常规道路逆行Counter Flow on Regular Road":null,"单行线逆行Counter Flow on One-way Road":null,"路口逆行 Counter Flow at Intersection":null},
  "号牌违章":{"遮挡":{"轻微遮挡":null,"完全遮挡":null},"故意损坏":null,"无牌照":null,"其他":null},
  "通行道路违规":{"违规行驶非机动车道":null,"违规行驶人行道":null,"违规行驶机动车道":{"不使用最右道通行":null,"驶入公交道":null,"不驶入最左侧车道左转掉头":null,"其他":null}},
  "装载":{"超高":null,"超宽":null,"超长":null},
  "干扰驾驶":{"使用手持设备":null,"外放音乐":null,"吸烟":null,"其他":null},
  "等候位置":{"停止线后":null,"人行横道上":null,"路口其他区域":null},
  "其他行为":{"鸣笛":null,"转弯不打信号灯":null,"其他":null},
  "停车":{"停入路侧停车位":null,"停入人行道":null,"堵塞出入口消防通道":null,"停在路肩":null,"其他":null}
};

// ---------- 页面控制 ----------
function show(id){
  document.querySelectorAll('.container > div, #pagePrimary, #pageSecondary, #pageTertiary, #pagePhoto, #pageMulti, #pageNote')
    .forEach(el=>el.classList.add('hidden'));
  const el=document.getElementById(id);
  if(el) el.classList.remove('hidden');
}

// ---------- 登录 ----------
function login(){
  const obs = document.getElementById('observer').value.trim();
  if(!obs){ alert('请输入观察人代号'); return; }
  observerName = obs;
  document.getElementById('violationCount').classList.remove('hidden');
  document.getElementById('menuContainer').classList.remove('hidden');
  show('page1');
}

// ---------- 开始记录 ----------
function startRecording(){
  const loc = document.getElementById('location').value.trim();
  if(!loc){ alert('请填写地址/位置ID'); return; }
  show('pagePhoto');
}

// ---------- 拍照 ----------
function takePhotoThenMenu(){
  const input = document.getElementById('cameraInput');
  input.onchange = function(e){
    const files = e.target.files;
    prepareCurrentRecord(Array.from(files));
    try{ input.value=''; }catch(e){}
    populatePrimaryButtons();
    show('pagePrimary');
  };
  input.click();
}

function skipPhotoThenMenu(){
  prepareCurrentRecord([]);
  populatePrimaryButtons();
  show('pagePrimary');
}

function prepareCurrentRecord(photoFiles){
  currentRecord = {
    violationID: currentViolationID,
    time: new Date().toISOString(),
    observer: observerName,
    location: document.getElementById('location').value.trim(),
    locationType: document.getElementById('locationType').value,
    weather: Array.from(document.getElementById('weather').selectedOptions).map(o=>o.value).join(','),
    roadType: document.getElementById('roadType').value,
    photosFiles: photoFiles || [],
    photosNames: [],
    primary:'', secondary:'', tertiary:'', note:'', hasMore:false
  };
}

// ---------- 行为选择 ----------
function populatePrimaryButtons(){
  const container=document.getElementById('primaryButtons'); container.innerHTML='';
  Object.keys(behaviors).forEach(key=>{
    const b=document.createElement('button'); b.className='behavior-btn'; b.textContent=key;
    b.onclick=()=>selectPrimary(key); container.appendChild(b);
  });
}
function selectPrimary(key){
  if(!currentRecord){ alert('请先拍照或跳过拍照'); return; }
  currentRecord.primary=key;
  const sec=behaviors[key];
  if(sec && Object.keys(sec).length>0){ populateSecondaryButtons(sec); show('pageSecondary'); }
  else{ show('pageMulti'); }
}
function populateSecondaryButtons(secObj){
  const container=document.getElementById('secondaryButtons'); container.innerHTML='';
  Object.keys(secObj).forEach(s=>{
    const b=document.createElement('button'); b.className='behavior-btn'; b.textContent=s;
    b.onclick=()=>selectSecondary(s); container.appendChild(b);
  });
}
function selectSecondary(sec){
  currentRecord.secondary=sec;
  const tert=behaviors[currentRecord.primary][sec];
  if(tert && Object.keys(tert).length>0){ populateTertiaryButtons(tert); show('pageTertiary'); }
  else{ show('pageMulti'); }
}
function populateTertiaryButtons(terObj){
  const container=document.getElementById('tertiaryButtons'); container.innerHTML='';
  Object.keys(terObj).forEach(t=>{
    const b=document.createElement('button'); b.className='behavior-btn'; b.textContent=t;
    b.onclick=()=>selectTertiary(t); container.appendChild(b);
  });
}
function selectTertiary(t){ currentRecord.tertiary=t; show('pageMulti'); }

function multiChoice(hasMore){ currentRecord.hasMore=!!hasMore; show('pageNote'); }
function saveRecord(){
  if(paused){ alert('记录已暂停，无法保存'); return; }
  currentRecord.note=document.getElementById('note').value.trim()||'';
  if(!currentRecord.photosFiles) currentRecord.photosFiles=[];
  currentRecord.photosNames=currentRecord.photosFiles.map((f,idx)=>{
    const ext=(f&&f.name&&f.name.split('.').pop())?f.name.split('.').pop().split('?')[0]:'jpg';
    return `photo_${currentRecord.violationID}_${idx+1}.${ext}`;
  });
  records.push(currentRecord); updateViolationCount();
  document.getElementById('note').value='';
  if(currentRecord.hasMore){ show('pagePhoto'); }
  else{ currentViolationID++; show('pagePhoto'); }
  currentRecord=null;
}

// ---------- 暂停/恢复 ----------
function pauseResume(){
  paused=!paused;
  document.getElementById('pauseBtn').textContent = paused ? '恢复记录' : '暂停记录';
  alert(paused?'记录已暂停':'记录已恢复');
}

// ---------- 导出 ZIP ----------
async function exportZip(){
  if(records.length===0){ alert('当前没有记录需要导出'); return; }
  const zip=new JSZip(); const photosFolder=zip.folder('photos');
  let csv='违规ID,时间,观察人,地址/位置ID,地点类型,天气,道路类型,行为1,行为2,行为3,备注,照片文件\n';
  for(const r of records){
    let photoFileNames=[];
    if(r.photosFiles&&r.photosFiles.length>0){
      for(let i=0;i<r.photosFiles.length;i++){
        const file=r.photosFiles[i];
        const ext=(file&&file.name&&file.name.split('.').pop())?file.name.split('.').pop().split('?')[0]:'jpg';
        const filename=`photo_${r.violationID}_${i+1}.${ext}`;
        photoFileNames.push(filename);
        try{
          const arrayBuffer=await file.arrayBuffer();
          photosFolder.file(filename,arrayBuffer);
        }catch{
          const arrayBuffer=await new Promise((resolve,reject)=>{
            const fr=new FileReader();
            fr.onload=()=>resolve(fr.result);
            fr.onerror=()=>reject(fr.error);
            fr.readAsArrayBuffer(file);
          });
          photosFolder.file(filename,arrayBuffer);
        }
      }
    }
    const esc=v=>`"${String(v||'').replace(/"/g,'""')}"`;
    csv+=[esc(r.violationID),esc(r.time),esc(r.observer),esc(r.location),esc(r.locationType),esc(r.weather),
      esc(r.roadType),esc(r.primary||''),esc(r.secondary||''),esc(r.tertiary||''),esc(r.note||''),esc(photoFileNames.join(';'))].join(',')+'\n';
  }
  zip.file('records.csv',csv);
  const content=await zip.generateAsync({type:'blob'});
  const url=URL.createObjectURL(content);
  const a=document.createElement('a'); a.href=url; a.download='records_export.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  alert('ZIP 已生成并下载');
  records=[]; currentViolationID=1; updateViolationCount(); show('page1');
}

function updateViolationCount(){
  const unique=[...new Set(records.map(r=>r.violationID))];
  document.getElementById('violationCount').innerText=`已记录的违规次数：${unique.length}`;
}

// ---------- 菜单折叠 ----------
document.getElementById('menuToggleBtn').addEventListener('click', ()=>{
  const menu=document.getElementById('menu');
  menu.classList.toggle('hidden');
});

document.addEventListener('DOMContentLoaded', ()=>{
  show('loginPage');
});

window.takePhotoThenMenu=takePhotoThenMenu;
window.skipPhotoThenMenu=skipPhotoThenMenu;
window.startRecording=startRecording;
window.login=login;
window.pauseResume=pauseResume;
window.multiChoice=multiChoice;
window.saveRecord=saveRecord;
window.exportZip=exportZip;
window.populatePrimaryButtons=populatePrimaryButtons;

</script>
</body>
</html>
